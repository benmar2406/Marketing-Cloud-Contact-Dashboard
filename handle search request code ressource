<script runat="server">
Platform.Load("Core","1.1.1");

var result = {
    success: false,
    error: null,
    contacts: [],
    subscriberOnly: false
};
var output;

try {
    var allowedReferrer = {{Origin CloudPage}};
    var referrer = Platform.Request.ReferrerURL();

    if (!referrer || referrer.indexOf(allowedReferrer) === -1) {
      throw "Unauthorized";
    }
  
    var searchTerm = Request.GetFormField('searchTerm');  
    var masterDEKey = {{Quell DE}};
    var subStatusDEKey ={{Zusätzliche DE}};

    if (searchTerm != null && searchTerm != "") {

        var columnsToRetrieve = [
            "ContactId", "Email", "Vorname", "Nachname", "Anrede", "PLZ", "Alter",
            "Interessent", "Teilnehmer", "Absolvent", "DoubleOptin",
            "Zuletzt_erhalten", "Zuletzt_gesendet_am", "Zuletzt_geoeffnet_am",
            "Zuletzt_geklickt_am", "Aktuelle_Journey", "Letzte_Journeyaktivitaet",
            "Datum_Letzte_Journeyaktivitaet"
        ];

        var regexEmail = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
        var regexSfId  = /^[A-Za-z0-9]{18}$/;

        var masterDE    = DataExtension.Init(masterDEKey);
        var subStatusDE = DataExtension.Init(subStatusDEKey);

        var filter = null;

        if (regexEmail.test(searchTerm)) {
            filter = { Property: "Email", SimpleOperator: "equals", Value: searchTerm };
        } else if (regexSfId.test(searchTerm)) {
            filter = { Property: "ContactId", SimpleOperator: "equals", Value: searchTerm };
        }

        if (filter) {
            var data = masterDE.Rows.Retrieve(filter, columnsToRetrieve);
            var subData = subStatusDE.Rows.Retrieve(filter, ["Status", "Datum_Unsubscribe"]);

            if (data && data.length > 0) {
                // Kontakt im Master-DE gefunden
                for (var i = 0; i < data.length; i++) {
                    var row = data[i];
                    var contact = {
                        contactId: row.ContactId,
                        email: row.Email,
                        vorname: row.Vorname,
                        nachname: row.Nachname,
                        anrede: row.Anrede,
                        plz: row.PLZ,
                        alter: row.Alter,
                        doubleOptin: (row.DoubleOptin === "True"),
                        interessent: (row.Interessent === "True"),
                        teilnehmer: (row.Teilnehmer === "True"),
                        absolvent: (row.Absolvent === "True"),
                        zuletztErhalten: row.Zuletzt_erhalten,
                        zuletztGesendetAm: row.Zuletzt_gesendet_am,
                        zuletztGeoeffnetAm: row.Zuletzt_geoeffnet_am,
                        zuletztGeklicktAm: row.Zuletzt_geklickt_am,
                        aktuelleJourney: row.Aktuelle_Journey,
                        letzteJourneyaktivitaet: row.Letzte_Journeyaktivitaet,
                        datumLetzteJourneyaktivitaet: row.Datum_Letzte_Journeyaktivitaet,
                        subscriberStatus: null,
                        subscriberUnsubscribeDate: null
                    };

                    if (subData && subData.length > 0) {
                        contact.subscriberStatus        = subData[0].Status;
                        contact.subscriberUnsubscribeDate = subData[0].Datum_Unsubscribe;
                    }

                    result.contacts.push(contact);
                }

                result.success = true;

            } else if (subData && subData.length > 0) {
                // Kein Master-Eintrag, aber All Subscribers vorhanden
                result.success = true;
                result.subscriberOnly = {
                    status: subData[0].Status,
                    datumUnsubscribe: subData[0].Datum_Unsubscribe
                };
                result.error = "Der Kontakt wird aktuell nicht synchronisiert.";

            } else {
                result.error = "Kontakt nicht gefunden: Kontakt existiert nicht oder wird aktuell nicht synchronisiert.";
            }

        } else {
            result.error = "Suchbegriff ist ungültig: " + searchTerm;
        }

    } else {
        result.error = "Bitte geben Sie einen Suchbegriff ein.";
    }

} catch (e) {
    // Falls result noch leer wäre, ist es oben bereits initialisiert
    result.success = false;
    result.error = String(e);
}

output = Stringify(result);
</script>
<ctrl:var name=output />
